\section{Modelling approach \emph{\textcolor{blue}{[Methods of] train path construction and assignment}}}
\label{chap:methods}
In this section we briefly describe our modelling approach to automatically compute timetables. It is divided into two main parts: First, we calculate train paths, which are located on the most frequently used part of the infrastructure (Section~\ref{chap:Konstruktion}). Therefore, we extend the idea of \cite{O:2009}. The second part is the train path assignment (Section~\ref{chap:Belegung}), based on the idea of \cite{N:1998, N:2015, NO:2014}, where some single Train paths are assigned to a complete timetable.


\subsection{Train path calculation}
\label{chap:Konstruktion}
\textbf{
\textcolor{red}{TODO by Florian}
\begin{itemize}
	\item Konstruktion kurz beschreiben ($\leq$1Seite)
	\item Routing \textbf{DONE}
	\item snippet creation \textbf{OPEN}
	\item train path calculation \textbf{OPEN}
\end{itemize}
}

This section will give a brief overview of the process used for creating a train path. The entire process consists of three main steps. First, we search one or more different routes through the infrastructure. In the second step we create a network of discrete building blocks (called snippets) along these routes for which we calculate travel and blocking times. Finally, we put these snippets together to form a non conflicting train path.


\subsubsection{Routing}

To reduce the problem size, our first step consists of finding routes that could be relevant for the train. We use an A* algorithm for finding a shortest route, which utilizes geo coordinates for calculating the beeline distance as the lower bound. The infrastructure of Deutsche Bahn is divided into sections called \emph{Betriebstellen}. For each Betriebstelle we keep a list of all possible ways to traverse it. Each possibility is termed a \emph{Fahrweg}. The Fahrwege form a graph where each Fahrweg is a vertex, with directed edges indicating which Fahrweg is a direct successor of another. The edge costs are based on the Fahrwege lengths. But as certain Fahrwege are preferred to others we multiply the cost with factor which is closer to one for more desirable Fahrwege. This way the use of intersections and the use of tracks from the opposite direction can be discouraged. It is this graph we use of finding routes for our train paths.

While exploring the graph the algorithm filters out all paths, which are incompatible with the characteristics of the train.
As it is not always the best option to use the shortest path, we create multiple alternative routes. For searching the subsequent routes, we increase the costs of edges that where used in already found routes. A route is only accepted as a real alternative if it differs from all already calculated one in at least one Betriebstelle. We set an upper limit to the length of alternative routes which is a multiple ($1.3$ in the experiments) of the shortest route found.


\subsubsection{Snippet Creation}


\subsubsection{Train Path Calculation}


\subsection{train path assignment}
\label{chap:Belegung}
\textbf{
	\textcolor{red}{TODO by SK}
\begin{itemize}
	\item Belegung kurz beschreiben ($\leq$1Seite)
\end{itemize}
}
As a result of the train path calculation described in the previous section (Section~\ref{chap:Konstruktion}), we are provided with a directed graph \G\, in which the Systemtrassen and \emph{\textcolor{red}{Spurplanknoten or BST}} form the arcs and the nodes, respectively. In a process consisting of four steps, this graph is used to assign train paths to the requests made by customers. First, we map the requests of the customer to the graph \G, resulting in so-called \emph{break-in} and \emph{break-out points}. Then, we search for the shortest path using Systemtrassen In the third part, we calculate train paths from the start of a request to the break-in point and from the break-out point to the goal of the request. Finally, we optimize the result for all requests using a column generation approach.

\subsubsection{Calculation of break-in and break-out points \emph{\textcolor{blue}{Mapping onto Systemtrassen}}}
As most customers do not put a request starting or ending at nodes of the graph \G\, (compare Figure~\ref{fig:E-A-Pkte}), we need to map the start of a request to break-in points and break-out points, which are nodes of the graph \G. Therefore, we calculate a number of different route (10 in the experiment), using the A* algorithm described previously. Then, beginning at the start of the route, we consecutively check for each \textcolor{red}{BST?} of each route whether it is associated to a node of the graph \G. If so, we found a break-in point and stop; otherwise the request has to be calculated individually. In order to find the break-out points, we repeat the above process starting from the end of each route.

\subsubsection{Routing on Systemtrassen}
The mapping of a request previously described may not be unique, resulting in a time-dependent multi-source-multi-sink shortest path problem to be solved for each request. Furthermore, due to the technical properties of the requests such as e.g.\ length, acceleration or width, the use of Systemtrassen is restricted depending on the request.
We use standard techniques like time expansion to tackle the time dependency, dummy edges for multi-source and multi-sink problem as well as dynamic filters for the technical properties, reducing the problem to a standard shortest path problem, which we solve using a Dijkstra algorithm.

\subsubsection{Vor-/Nachlauf}

\subsubsection{Optimization}
The process described above is sufficient if only one request hast to be fulfilled at a time like in the use case of the app. But as there is more than one request in the use case of Netzfahrplan the simple assignment of the shortest path for each request leads to conflicts between the train paths. We solve these conflicts using a column generation approach, where in each iteration we generate new train paths which resolve more conflicts than in the iteration before. Our experiments show, that the process terminates within up to 10 hours for sufficiently large problems (compare Section~\ref{chap:Netzfahrplan}).